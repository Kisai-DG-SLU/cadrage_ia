name: Cadrage-IA-CI

on:
  push:
    branches:
      - main
      - 'feat/*'
      - 'fix/*'
      - 'docs/*'
      - 'temp/*'

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check Deliverables
        run: |
          if [ ! -f "delivery/PRESENTATION.md" ]; then
            echo "Error: PRESENTATION.md missing"
            exit 1
          fi
          echo "Delivery OK"

    outputs:
      should_merge: ${{ steps.check_merge.outputs.should_merge }}

    - name: Check if merge required
      id: check_merge
      run: |
        if [[ "${{ github.ref }}" != "refs/heads/main" ]]; then
          echo "should_merge=true" >> $GITHUB_OUTPUT
        else
          echo "should_merge=false" >> $GITHUB_OUTPUT
        fi

  auto-merge:
    needs: validate
    if: needs.validate.outputs.should_merge == 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.ref_name }}
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

    - name: Merge Logic
      env:
        SOURCE_BRANCH: ${{ github.ref_name }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh pr create --base main --head "$SOURCE_BRANCH" --title "docs: delivery consolidation" --body "Automated delivery merge" || echo "PR exists"
        PR_URL=$(gh pr list --head "$SOURCE_BRANCH" --json url --jq '.[0].url')
        gh pr merge --auto --merge --delete-branch "$PR_URL"
